<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contrato Acceso Dedicado a Internet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { theme: { extend: {} } };</script>
  <style>
    :root{ --accent:#0ea5e9; --accent2:#22c55e; }
    .brand-gradient{ background: linear-gradient(90deg, var(--accent), var(--accent2)); }
    .input{ background:#111827!important; border:1px solid #334155!important; border-radius:10px!important; padding:.7rem .9rem!important; width:100%!important; color:#f8fafc!important; -webkit-text-fill-color:#f8fafc!important; font-weight:600!important; caret-color:#22d3ee!important; transition:.15s }
    .input::placeholder{ color:#9ca3af; opacity:1 }
    .input:focus{ outline:none; border-color:#22d3ee!important; box-shadow:0 0 0 2px #22d3ee55; background:#0f172a!important }
    .btn{ background:var(--accent); color:#001014; font-weight:700; border-radius:14px; padding:.7rem 1rem; text-align:center }
    .btn.alt{ background:#334155; color:#e5e7eb }
    #loginOverlay{ position:fixed; inset:0; background:rgba(2,6,23,.9); display:flex; align-items:center; justify-content:center; z-index:50 }
    .modal{ position:fixed; inset:0; background:rgba(2,6,23,.85); display:none; align-items:center; justify-content:center; z-index:60 }
    .badge{ font-size:.75rem; padding:.15rem .5rem; border-radius:999px; background:#374151; color:#e5e7eb; font-weight:700 }
    table{ border-collapse:collapse; width:100% } th,td{ border-bottom:1px solid #334155; padding:.5rem; text-align:left }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">

  <!-- LOGIN -->
  <div id="loginOverlay">
    <div class="w-[95%] max-w-md bg-slate-900/80 border border-slate-700 rounded-2xl p-6 backdrop-blur-md shadow">
      <h2 class="text-xl font-bold mb-4">Acceso</h2>
      <div class="space-y-3">
        <input id="loginUser" class="input" placeholder="Usuario" autocomplete="username">
        <input id="loginPass" class="input" type="password" placeholder="Contraseña" autocomplete="current-password">
        <button id="loginBtn" class="btn w-full">Ingresar</button>
        <button id="resetAll" class="btn alt w-full">Restablecer acceso</button>
        <p id="loginMsg" class="text-sm text-red-400 h-5"></p>
        <p id="ipInfo" class="text-xs opacity-70 h-4"></p>
        <p class="text-xs opacity-70">*Acceso local de conveniencia. No usar para datos sensibles.</p>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="brand-gradient p-5 shadow-xl">
    <div class="flex items-center justify-between gap-3">
      <h1 class="text-2xl font-bold">Contrato Acceso Dedicado a Internet</h1>
      <div class="flex items-center gap-2">
        <span id="whoami" class="text-sm px-2 py-1 rounded bg-black/20"></span>
        <button id="btnConfig" class="text-sm px-3 py-1 rounded bg-black/20 hover:bg-black/30 hidden">Configuración</button>
        <button id="logoutBtn" class="text-sm px-3 py-1 rounded bg-black/20 hover:bg-black/30">Salir</button>
      </div>
    </div>
  </header>

  <!-- MODAL CONFIG (solo admin) -->
  <div id="configModal" class="modal">
    <div class="w-[95%] max-w-5xl bg-slate-900/90 border border-slate-700 rounded-2xl p-6 backdrop-blur-md shadow relative">
      <button id="closeConfig" class="absolute right-3 top-3 px-2 py-1 bg-slate-800/70 rounded">✕</button>
      <h2 class="text-xl font-bold mb-4">Configuración (Admin)</h2>

      <div class="grid md:grid-cols-2 gap-6">
        <div>
          <h3 class="font-semibold mb-2">Crear nuevo usuario (standard)</h3>
          <div class="grid sm:grid-cols-3 gap-3">
            <input id="newUser" class="input" placeholder="Usuario">
            <input id="newPass" class="input" type="password" placeholder="Contraseña">
            <select id="newRole" class="input" disabled>
              <option value="standard" selected>standard (solo IP 190.235.163.141)</option>
            </select>
          </div>
          <div class="flex gap-3 mt-3">
            <button id="btnCreateUser" class="btn">Crear usuario</button>
            <p id="userMsg" class="text-sm opacity-80"></p>
          </div>

          <h3 class="font-semibold mt-6 mb-2">Usuarios registrados</h3>
          <div id="usersList" class="text-sm space-y-1"></div>
        </div>

        <div>
          <div class="flex items-center justify-between">
            <h3 class="font-semibold mb-2">Registros de contratos</h3>
            <button id="clearLogs" class="btn alt text-xs">Limpiar registros</button>
          </div>
          <div class="max-h-[350px] overflow-auto border border-slate-700/70 rounded-lg">
            <table class="text-sm">
              <thead class="bg-slate-800/80 sticky top-0">
                <tr>
                  <th>Fecha</th><th>Usuario</th><th>RUC</th><th>Razón Social</th><th>RL</th><th>Teléfono</th><th>Correo</th>
                </tr>
              </thead>
              <tbody id="logsBody"></tbody>
            </table>
          </div>
          <p class="text-xs opacity-70 mt-2">Solo visible para el administrador.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-6 space-y-8">
    <section class="grid md:grid-cols-3 gap-6">
      <div class="md:col-span-2 space-y-6">
        <!-- 1) Datos del Representante Legal -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">1) Datos del Representante Legal</h2>
          <div class="grid sm:grid-cols-2 gap-3">
            <input id="RAZON_SOCIAL" class="input" placeholder="RAZON SOCIAL">
            <input id="RUC" class="input" placeholder="RUC">
            <input id="DIRECCION" class="input" placeholder="DIRECCION">
            <input id="NUMERO_DE_CALLE" class="input" placeholder="NUMERO DE CALLE">
            <input id="DPTO_INT" class="input" placeholder="DPTO_INT">
            <input id="URB" class="input" placeholder="URB">
            <input id="DISTRITO" class="input" placeholder="DISTRITO">
            <input id="CIUDAD" class="input" placeholder="CIUDAD">
            <input id="APELLIDO_PATERNO" class="input" placeholder="APELLIDO PATERNO">
            <input id="APELLIDO_MATERNO" class="input" placeholder="APELLIDO MATERNO">
            <input id="NOMBRES" class="input" placeholder="NOMBRES">
            <input id="CARGO" class="input" placeholder="CARGO">
            <input id="DNI" class="input" placeholder="DNI">
            <input id="TELEFONO" class="input" placeholder="TELEFONO">
            <input id="CORREO" class="input col-span-2" placeholder="CORREO">
          </div>
        </div>

        <!-- 2) Contacto -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">2) Contacto de Instalación</h2>
          <div class="grid sm:grid-cols-2 gap-3">
            <input id="CONT_NOMB" class="input" placeholder="CONT_NOMB">
            <input id="CONT_CARGO" class="input" placeholder="CONT_CARGO">
            <input id="CONT_DNI" class="input" placeholder="CONT_DNI">
            <input id="CONT_TELEF" class="input" placeholder="CONT_TELEF">
            <input id="CONT_CORREO" class="input col-span-2" placeholder="CONT_CORREO">
          </div>
        </div>

        <!-- 3) Fecha -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">3) Fecha de Firma</h2>
          <div class="grid sm:grid-cols-3 gap-3">
            <input id="DIA" class="input" placeholder="DIA">
            <input id="MES" class="input" placeholder="MES">
            <input id="ANO" class="input" placeholder="AÑO">
          </div>
        </div>

        <!-- 4) Firmante -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">4) Firmante</h2>
          <div class="grid sm:grid-cols-2 gap-3">
            <input id="RL" class="input" placeholder="RL">
            <input id="CARGO_FIRM" class="input" placeholder="CARGO (Firmante)">
          </div>
        </div>

        <!-- 5) Suplementarios -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">5) Servicios Suplementarios</h2>
          <div class="grid sm:grid-cols-3 gap-3">
            <input id="CANTIDAD" class="input" placeholder="CANTIDAD" inputmode="numeric">
            <input id="SUB_TOTAL" class="input" placeholder="S/ 0.00" inputmode="decimal">
            <input id="NOMB_PROMOCION" class="input" placeholder="NOMB_PROMOCION">
          </div>
          <div class="mt-3 grid sm:grid-cols-2 gap-3">
            <input id="DIREC_INST" class="input" placeholder="DIREC_INST (Dirección de instalación)">
            <input id="CONT_TOTAL" class="input" placeholder="S/ 0.00 (TOTAL opcional)" inputmode="decimal">
          </div>
        </div>

        <!-- 6) Tarifas y Servicios -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">6) Tarifas y Servicios</h2>
          <div class="grid sm:grid-cols-2 gap-3 mb-3">
            <select id="planSelect" class="input">
              <option value="">— Selecciona un plan —</option>
            </select>
            <input id="TARIF_MENS" class="input" placeholder="S/ 0.00">
          </div>
          <div class="grid sm:grid-cols-3 gap-3">
            <input id="NOM_PLAN" class="input" placeholder="NOM_PLAN">
            <input id="MIN_GAR" class="input" placeholder="MIN_GAR (%)">
            <input id="VEL_MAX_BAJ" class="input" placeholder="VEL_MAX_BAJ (Mbps)" inputmode="numeric">
            <input id="VEL_MIN_BAJ" class="input" placeholder="VEL_MIN_BAJ (Mbps)" inputmode="numeric">
            <input id="VEL_MAX_SUB" class="input" placeholder="VEL_MAX_SUB (Mbps)" inputmode="numeric">
            <input id="VEL_MIN_SUB" class="input" placeholder="VEL_MIN_SUB (Mbps)" inputmode="numeric">
          </div>
          <div class="grid sm:grid-cols-2 gap-3 mt-3">
            <input id="PLAZO_INST" class="input" placeholder="PLAZO_INST (días hábiles)" inputmode="numeric">
            <select id="PLAZO_CONT" class="input">
              <option value="">— Selecciona plazo (meses) —</option>
              <option value="12">12</option>
              <option value="24">24</option>
              <option value="36">36</option>
            </select>
          </div>
          <div class="mt-4 flex gap-3">
            <button id="btnAuto" class="btn">Autocompletar por plan</button>
            <button id="btnClearPlan" class="btn alt">Limpiar plan</button>
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="space-y-6">
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-lg font-semibold mb-3">Exportar PDFs</h2>
          <div class="flex flex-col gap-3">
            <button id="btnAll" class="btn w-full">GENERAR CONTRATOS</button>
            <a id="downloadLink" class="hidden btn" download>Descargar</a>
            <p id="status" class="text-sm opacity-80"></p>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    /* ========= Constantes / Claves ========= */
    const USERS_KEY='contratos_users', LOG_KEY='contratos_login_ok', USER_KEY='contratos_login_user', LOGS_KEY='contratos_registros';
    const ADMIN={u:'mob_hmedinab',p:'adminMobilenet2025',role:'admin'};
    const IP_ALLOWED='190.235.163.141';

    /* ========= Util localStorage ========= */
    function loadUsers(){ try{return JSON.parse(localStorage.getItem(USERS_KEY))||[]}catch{return []} }
    function saveUsers(a){ localStorage.setItem(USERS_KEY,JSON.stringify(a)) }
    function ensureAdmin(){ const a=loadUsers(); if(!a.some(x=>x&&x.u===ADMIN.u)){ a.push(ADMIN); saveUsers(a); } }
    ensureAdmin();

    function setLogged(user){ localStorage.setItem(LOG_KEY,'1'); localStorage.setItem(USER_KEY,JSON.stringify(user)); }
    function getLogged(){ try{ return JSON.parse(localStorage.getItem(USER_KEY)) }catch{ return null } }
    function clearLogged(){ localStorage.removeItem(LOG_KEY); localStorage.removeItem(USER_KEY); }

    /* ========= IP pública (solo para usuarios standard) ========= */
    let CURRENT_IP=null;
    async function fetchIP(){
      try{
        const ctrl=new AbortController(); setTimeout(()=>ctrl.abort(),5000);
        const r=await fetch('https://api.ipify.org?format=json',{signal:ctrl.signal});
        const j=await r.json(); CURRENT_IP=j.ip||null;
        document.getElementById('ipInfo').textContent='Tu IP pública: '+CURRENT_IP;
      }catch{
        document.getElementById('ipInfo').textContent='No se pudo detectar la IP pública (no afecta al admin).';
        CURRENT_IP=null;
      }
    }
    fetchIP();

    /* ========= Arranque / Sesión ========= */
    function showApp(){ document.getElementById('loginOverlay').style.display='none'; applyRoleUI(); populatePlans(); }
    function softGuardStaleSession(){
      // Si quedó LOG_KEY=1 pero USER_KEY inválida -> salir y mostrar login
      const lk=localStorage.getItem(LOG_KEY);
      const uk=localStorage.getItem(USER_KEY);
      if(lk==='1'){
        try{ JSON.parse(uk); }catch{ clearLogged(); }
      }
    }
    softGuardStaleSession();

    function requireLogin(){
      if(localStorage.getItem(LOG_KEY)==='1' && getLogged()){ showApp(); return; }
      const btn=document.getElementById('loginBtn');
      const msg=document.getElementById('loginMsg');
      document.getElementById('resetAll').addEventListener('click',()=>{
        localStorage.removeItem(USERS_KEY); clearLogged(); ensureAdmin();
        msg.textContent='Acceso restablecido. Use credenciales de administrador.'; setTimeout(()=>msg.textContent='',3000);
      });
      btn.addEventListener('click',()=>{
        const u=document.getElementById('loginUser').value.trim();
        const p=document.getElementById('loginPass').value.trim();
        const all=loadUsers(); const found=all.find(x=>x.u===u && x.p===p);
        if(!found){ msg.textContent='Usuario o contraseña incorrectos.'; return; }
        if(found.role!=='admin'){
          if(CURRENT_IP!==IP_ALLOWED){
            msg.textContent='Acceso permitido solo desde la IP '+IP_ALLOWED+'. Detectada: '+(CURRENT_IP||'desconocida'); return;
          }
        }
        setLogged({u:found.u, role:found.role}); showApp();
      });
    }
    requireLogin();

    document.getElementById('logoutBtn').addEventListener('click',()=>{ clearLogged(); location.reload(); });

    /* ========= Header / Config ========= */
    const whoami=document.getElementById('whoami'), btnConfig=document.getElementById('btnConfig'), modal=document.getElementById('configModal'), closeCfg=document.getElementById('closeConfig');
    function applyRoleUI(){
      const me=getLogged(); if(!me) return;
      whoami.textContent=`Sesión: ${me.u} `;
      const b=document.createElement('span'); b.className='badge ml-2'; b.textContent=me.role; whoami.appendChild(b);
      if(me.role==='admin') btnConfig.classList.remove('hidden'); else btnConfig.classList.add('hidden');
    }
    btnConfig.addEventListener('click',()=>{ const me=getLogged(); if(!me||me.role!=='admin')return; renderUsers(); renderLogs(); modal.style.display='flex'; });
    closeCfg.addEventListener('click',()=> modal.style.display='none');
    modal.addEventListener('click',e=>{ if(e.target===modal) modal.style.display='none'; });

    /* ========= Crear usuarios ========= */
    document.getElementById('btnCreateUser').addEventListener('click',()=>{
      const me=getLogged(); if(!me||me.role!=='admin') return;
      const u=document.getElementById('newUser').value.trim();
      const p=document.getElementById('newPass').value.trim();
      const msg=document.getElementById('userMsg');
      if(!u||!p){ msg.textContent='Completa usuario y contraseña.'; return; }
      const arr=loadUsers(); if(arr.some(x=>x.u===u)){ msg.textContent='Ese usuario ya existe.'; return; }
      arr.push({u,p,role:'standard'}); saveUsers(arr);
      msg.textContent='Usuario creado (solo IP 190.235.163.141).';
      document.getElementById('newUser').value=''; document.getElementById('newPass').value='';
      renderUsers();
    });
    function renderUsers(){
      const c=document.getElementById('usersList'); c.innerHTML='';
      loadUsers().forEach(x=>{
        const row=document.createElement('div');
        row.className='flex items-center justify-between bg-slate-800/50 px-3 py-2 rounded';
        row.innerHTML=`<div><span class="font-semibold">${x.u}</span><span class="badge ml-2">${x.role}</span></div><span class="text-xs opacity-60">${x.role==='admin'?'sin restr. IP':'IP 190.235.163.141'}</span>`;
        c.appendChild(row);
      });
    }

    /* ========= Registros ========= */
    function loadLogs(){ try{return JSON.parse(localStorage.getItem(LOGS_KEY))||[]}catch{return []} }
    function saveLogs(a){ localStorage.setItem(LOGS_KEY, JSON.stringify(a)); }
    function addLog(rec){ const a=loadLogs(); a.unshift(rec); saveLogs(a); }
    function renderLogs(){
      const tb=document.getElementById('logsBody'); tb.innerHTML='';
      loadLogs().forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.date}</td><td>${r.user}</td><td>${r.RUC}</td><td>${r.RAZON_SOCIAL}</td><td>${r.RL}</td><td>${r.TELEFONO}</td><td>${r.CORREO}</td>`;
        tb.appendChild(tr);
      });
    }
    document.getElementById('clearLogs').addEventListener('click',()=>{ saveLogs([]); renderLogs(); });

    /* ========= Util dinero ========= */
    const solesFmt=new Intl.NumberFormat('es-PE',{style:'currency',currency:'PEN',minimumFractionDigits:2});
    function normalizeMoneyInput(v){ if(!v) return ''; v=String(v).replace(/[^0-9,\.]/g,'').replace(',', '.'); const n=parseFloat(v); if(isNaN(n)) return ''; let f=solesFmt.format(n); f=f.replace('PEN','').trim().replace(/^S\$/,'S/').replace('S/.','S/'); if(!f.startsWith('S/')) f='S/ '+f; return f }
    ;['SUB_TOTAL','CONT_TOTAL','TARIF_MENS'].forEach(id=>{const el=document.getElementById(id); if(el) el.addEventListener('blur',()=>{el.value=normalizeMoneyInput(el.value)})});
    function byId(id){ return document.getElementById(id) }
    function setVal(id,val){ const el=byId(id); if(el) el.value=val??'' }

    /* ========= Planes ========= */
    const PLANS=[{name:"Internet Fibra Plus 100 Mbps - 36M",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 270.00"},{name:"Internet Fibra Plus 200 Mbps - 36M",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 360.00"},{name:"Internet Fibra Plus 100 Mbps - 24M",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 370.00"},{name:"Internet Fibra Plus 200 Mbps - 24M",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 490.00"},{name:"Pack Fibra Plus 100 Mbps - 36M",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 279.90"},{name:"Pack Fibra Plus 200 Mbps - 36M",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 369.90"},{name:"Pack Fibra Plus 100 Mbps - 24M",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 379.90"},{name:"Pack Fibra Plus 200 Mbps - 24M",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 499.90"},{name:"Internet Dedicado 10 Mbps",minGar:"100%",vmb:10,vminb:10,vms:10,vmins:10,tarif:"S/ 500.00"},{name:"Internet Dedicado 20 Mbps",minGar:"100%",vmb:20,vminb:20,vms:20,vmins:20,tarif:"S/ 550.00"},{name:"Internet Dedicado 50 Mbps",minGar:"100%",vmb:50,vminb:50,vms:50,vmins:50,tarif:"S/ 590.00"},{name:"Internet Dedicado 100 Mbps",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 690.00"},{name:"Internet Dedicado 200 Mbps",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 1,100.00"},{name:"Internet Dedicado 250 Mbps",minGar:"100%",vmb:250,vminb:250,vms:250,vmins:250,tarif:"S/ 1,400.00"}];
    function populatePlans(){ const select=document.getElementById('planSelect'); if(!select) return; select.innerHTML='<option value="">— Selecciona un plan —</option>'; PLANS.forEach(p=>{const opt=document.createElement('option'); opt.value=p.name; opt.textContent=p.name; select.appendChild(opt)}) }
    function fillPlanFromSelection(){ const sel=planSelect.value; const p=PLANS.find(x=>x.name===sel); if(!p) return; setVal('NOM_PLAN',p.name); setVal('MIN_GAR',p.minGar); setVal('VEL_MAX_BAJ',String(p.vmb)); setVal('VEL_MIN_BAJ',String(p.vminb)); setVal('VEL_MAX_SUB',String(p.vms)); setVal('VEL_MIN_SUB',String(p.vmins)); setVal('TARIF_MENS',p.tarif); const m=p.name.match(/(\d{2})M/); const plazo=m?m[1]:''; const plazoSel=document.getElementById('PLAZO_CONT'); if(plazo&&['12','24','36'].includes(plazo)) plazoSel.value=plazo }
    const planSelect=document.getElementById('planSelect');
    document.getElementById('btnAuto').addEventListener('click',fillPlanFromSelection);
    planSelect.addEventListener('change',fillPlanFromSelection);
    document.getElementById('btnClearPlan').addEventListener('click',()=>{ ['NOM_PLAN','MIN_GAR','VEL_MAX_BAJ','VEL_MIN_BAJ','VEL_MAX_SUB','VEL_MIN_SUB','TARIF_MENS'].forEach(id=>setVal(id,'')); document.getElementById('PLAZO_CONT').value=''; planSelect.value='' });

    /* ========= Recolección ========= */
    function gatherData(){
      const ids=['RAZON_SOCIAL','RUC','DIRECCION','NUMERO_DE_CALLE','DPTO_INT','URB','DISTRITO','CIUDAD','APELLIDO_PATERNO','APELLIDO_MATERNO','NOMBRES','CARGO','DNI','TELEFONO','CORREO','CONT_NOMB','CONT_CARGO','CONT_DNI','CONT_TELEF','CONT_CORREO','DIA','MES','ANO','RL','CARGO_FIRM','CANTIDAD','SUB_TOTAL','NOMB_PROMOCION','DIREC_INST','CONT_TOTAL','NOM_PLAN','MIN_GAR','VEL_MAX_BAJ','VEL_MIN_BAJ','VEL_MAX_SUB','VEL_MIN_SUB','TARIF_MENS','PLAZO_INST','PLAZO_CONT'];
      const data={}; ids.forEach(id=>{ let v=byId(id)?.value??''; if(['SUB_TOTAL','CONT_TOTAL','TARIF_MENS'].includes(id)) v=normalizeMoneyInput(v); if(id==='PLAZO_CONT') v=String(v).trim(); data[id]=v; }); return data;
    }

    /* ========= Mapeos PDFs ========= */
    const MAP_ARR={'RUC':'RUC','RAZON SOCIAL':'RAZON_SOCIAL','DIRECCION':'DIRECCION','NUMERO DE CALLE':'NUMERO_DE_CALLE','DPTO_INT':'DPTO_INT','URB':'URB','DISTRITO':'DISTRITO','CIUDAD':'CIUDAD','APELLIDO PATERNO':'APELLIDO_PATERNO','APELLIDO MATERNO':'APELLIDO_MATERNO','NOMBRES':'NOMBRES','DNI':'DNI','TELEFONO':'TELEFONO','CORREO':'CORREO','CONT_NOMB':'CONT_NOMB','CONT_CARGO':'CONT_CARGO','CONT_DNI':'CONT_DNI','CONT_TELEF':'CONT_TELEF','CONT_CORREO':'CONT_CORREO','DIA':'DIA','MES':'MES','AÑO':'ANO','RL':'RL','CARGO':'CARGO_FIRM'};
    const MAP_SUP={'RUC':'RUC','RAZON SOCIAL':'RAZON_SOCIAL','DIRECCION':'DIRECCION','NUMERO DE CALLE':'NUMERO_DE_CALLE','DPTO_INT':'DPTO_INT','URB':'URB','DISTRITO':'DISTRITO','CIUDAD':'CIUDAD','APELLIDO PATERNO':'APELLIDO_PATERNO','APELLIDO MATERNO':'APELLIDO_MATERNO','NOMBRES':'NOMBRES','DNI':'DNI','TELEFONO':'TELEFONO','CORREO':'CORREO','CONT_NOMB':'CONT_NOMB','CONT_CARGO':'CONT_CARGO','CONT_DNI':'CONT_DNI','CONT_TELEF':'CONT_TELEF','CONT_CORREO':'CONT_CORREO','CANTIDAD':'CANTIDAD','SUB_TOTAL':'SUB_TOTAL','TOTAL':'CONT_TOTAL','NOMB_PROMOCION':'NOMB_PROMOCION','DIREC_INST':'DIREC_INST','DIA':'DIA','MES':'MES','AÑO':'ANO','RL':'RL','CARGO':'CARGO_FIRM'};
    const MAP_TAR={'CARGO FIJO':'TARIF_MENS','CARGO':'CARGO_FIRM','CORREO':'CORREO','DIA':'DIA','MES':'MES','AÑO':'ANO','RL':'RL','NOM_PLAN':'NOM_PLAN','MIN_GAR':'MIN_GAR','VEL_MAX_BAJ':'VEL_MAX_BAJ','VEL_MIN_BAJ':'VEL_MIN_BAJ','VEL_MAX_SUB':'VEL_MAX_SUB','VEL_MIN_SUB':'VEL_MIN_SUB','TARIF_MENS':'TARIF_MENS','DIREC_INST':'DIREC_INST','PLAZO_INST':'PLAZO_INST','PLAZO_CONT':'PLAZO_CONT'};

    async function fillOne(pdfFileName,map){
      const status=byId('status'); status.textContent='Cargando '+pdfFileName+'...';
      const resp=await fetch(pdfFileName);
      if(!resp.ok) throw new Error('No se pudo cargar '+pdfFileName);
      const arr=await resp.arrayBuffer();
      const pdfDoc=await PDFLib.PDFDocument.load(arr);
      const form=pdfDoc.getForm();
      const data=gatherData();
      let filled=0;
      for(const [pdfField,htmlId] of Object.entries(map)){
        try{ const tf=form.getTextField(pdfField); tf.setText(data[htmlId]??''); filled++; }
        catch(e){ console.warn('Campo faltante en', pdfFileName, pdfField); }
      }
      form.flatten();
      const bytes=await pdfDoc.save();
      const blob=new Blob([bytes],{type:'application/pdf'});
      const url=URL.createObjectURL(blob);
      const a=document.getElementById('downloadLink');
      a.href=url; a.download=pdfFileName; a.classList.remove('hidden'); a.click();
      status.textContent='Generado '+pdfFileName+' ('+filled+' campos).';
    }

    async function exportAll(){
      const me=getLogged()||{u:'(desconocido)'};
      await fillOne('Arrendamiento.pdf',MAP_ARR);
      await fillOne('Servicios Suplementarios.pdf',MAP_SUP);
      await fillOne('Tarifas y Servicios.pdf',MAP_TAR);
      const d=gatherData();
      addLog({ date:new Date().toLocaleString(), user:me.u, RUC:d.RUC||'', RAZON_SOCIAL:d.RAZON_SOCIAL||'', RL:d.RL||'', TELEFONO:d.TELEFONO||'', CORREO:d.CORREO||'' });
      const status=byId('status'); status.textContent=(status.textContent?status.textContent+' • ':'')+'Registro guardado.';
      if(getLogged()?.role==='admin' && document.getElementById('configModal').style.display==='flex'){ renderLogs(); }
    }
    document.getElementById('btnAll').addEventListener('click',exportAll);
  </script>
</body>
</html>
