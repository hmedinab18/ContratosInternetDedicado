<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Generador de Contratos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={theme:{extend:{}}}</script>
  <style>
    :root{--accent:#0ea5e9;--accent2:#22c55e;}
    .brand-gradient{background:linear-gradient(90deg,var(--accent),var(--accent2));}
    .input{background-color:#111827!important;border:1px solid #334155!important;border-radius:10px!important;padding:.7rem .9rem!important;width:100%!important;color:#f8fafc!important;-webkit-text-fill-color:#f8fafc!important;font-weight:600!important;caret-color:#22d3ee!important;transition:all .15s;}
    .input::placeholder{color:#9ca3af;opacity:1;}
    .input:focus{outline:none;border-color:#22d3ee!important;box-shadow:0 0 0 2px #22d3ee55;background-color:#0f172a!important;}
    .btn{background:var(--accent);color:#001014;font-weight:700;border-radius:14px;padding:.7rem 1rem;text-align:center}
    .btn.alt{background:#334155;color:#e5e7eb}
    #loginOverlay{position:fixed;inset:0;background:rgba(2,6,23,.9);display:flex;align-items:center;justify-content:center;z-index:50;}
    .modal{position:fixed;inset:0;background:rgba(2,6,23,.8);display:none;align-items:center;justify-content:center;z-index:60;}
    .badge{font-size:.75rem;padding:.15rem .5rem;border-radius:999px;background:#374151;color:#e5e7eb;font-weight:700}
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">

  <!-- LOGIN -->
  <div id="loginOverlay">
    <div class="w-[95%] max-w-md bg-slate-900/80 border border-slate-700 rounded-2xl p-6 backdrop-blur-md shadow">
      <h2 class="text-xl font-bold mb-4">Acceso</h2>
      <div class="space-y-3">
        <input id="loginUser" class="input" placeholder="Usuario" autocomplete="username" />
        <input id="loginPass" class="input" type="password" placeholder="Contraseña" autocomplete="current-password" />
        <button id="loginBtn" class="btn w-full">Ingresar</button>
        <button id="resetLogin" class="btn alt w-full">Restablecer acceso</button>
        <p id="loginMsg" class="text-sm text-red-400 h-5"></p>
        <p class="text-xs opacity-70">*Acceso local de conveniencia. No usar para datos sensibles.</p>
      </div>
    </div>
  </div>

  <!-- HEADER -->
  <header class="brand-gradient p-5 shadow-xl">
    <div class="flex items-center justify-between gap-3">
      <h1 class="text-2xl font-bold">GENERADOR DE CONTRATOS</h1>
      <div class="flex items-center gap-2">
        <span id="whoami" class="text-sm px-2 py-1 rounded bg-black/20"></span>
        <button id="btnConfig" class="text-sm px-3 py-1 rounded bg-black/20 hover:bg-black/30 hidden">Configuración</button>
        <button id="logoutBtn" class="text-sm px-3 py-1 rounded bg-black/20 hover:bg-black/30">Salir</button>
      </div>
    </div>
  </header>

  <!-- MODAL CONFIG (solo admin) -->
  <div id="configModal" class="modal">
    <div class="w-[95%] max-w-2xl bg-slate-900/90 border border-slate-700 rounded-2xl p-6 backdrop-blur-md shadow relative">
      <button id="closeConfig" class="absolute right-3 top-3 px-2 py-1 bg-slate-800/70 rounded">✕</button>
      <h2 class="text-xl font-bold mb-4">Configuración (Admin)</h2>

      <div class="space-y-3">
        <h3 class="font-semibold">Crear nuevo usuario</h3>
        <div class="grid sm:grid-cols-3 gap-3">
          <input id="newUser" class="input" placeholder="Usuario" />
          <input id="newPass" class="input" placeholder="Contraseña" type="password" />
          <select id="newRole" class="input">
            <option value="standard" selected>standard (sin configuración)</option>
          </select>
        </div>
        <div class="flex gap-3">
          <button id="btnCreateUser" class="btn">Crear usuario</button>
          <p id="userMsg" class="text-sm opacity-80"></p>
        </div>
      </div>

      <hr class="my-5 border-slate-700/70"/>
      <div class="space-y-2">
        <h3 class="font-semibold">Usuarios registrados</h3>
        <div id="usersList" class="text-sm space-y-1"></div>
        <p class="text-xs opacity-70">*Guardados en localStorage solo para demo.</p>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-6 space-y-8">
    <section class="grid md:grid-cols-3 gap-6">
      <div class="md:col-span-2 space-y-6">

        <!-- 1) Datos del Representante Legal -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">1) Datos del Representante Legal</h2>
          <div class="grid sm:grid-cols-2 gap-3">
            <input id="RAZON_SOCIAL" class="input" placeholder="RAZON SOCIAL" />
            <input id="RUC" class="input" placeholder="RUC" />
            <input id="DIRECCION" class="input" placeholder="DIRECCION" />
            <input id="NUMERO_DE_CALLE" class="input" placeholder="NUMERO DE CALLE" />
            <input id="DPTO_INT" class="input" placeholder="DPTO_INT" />
            <input id="URB" class="input" placeholder="URB" />
            <input id="DISTRITO" class="input" placeholder="DISTRITO" />
            <input id="CIUDAD" class="input" placeholder="CIUDAD" />
            <input id="APELLIDO_PATERNO" class="input" placeholder="APELLIDO PATERNO" />
            <input id="APELLIDO_MATERNO" class="input" placeholder="APELLIDO MATERNO" />
            <input id="NOMBRES" class="input" placeholder="NOMBRES" />
            <input id="CARGO" class="input" placeholder="CARGO" />
            <input id="DNI" class="input" placeholder="DNI" />
            <input id="TELEFONO" class="input" placeholder="TELEFONO" />
            <input id="CORREO" class="input col-span-2" placeholder="CORREO" />
          </div>
        </div>

        <!-- 2) Contacto de Instalación -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">2) Contacto de Instalación</h2>
          <div class="grid sm:grid-cols-2 gap-3">
            <input id="CONT_NOMB" class="input" placeholder="CONT_NOMB" />
            <input id="CONT_CARGO" class="input" placeholder="CONT_CARGO" />
            <input id="CONT_DNI" class="input" placeholder="CONT_DNI" />
            <input id="CONT_TELEF" class="input" placeholder="CONT_TELEF" />
            <input id="CONT_CORREO" class="input col-span-2" placeholder="CONT_CORREO" />
          </div>
        </div>

        <!-- 3) Fecha de Firma -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">3) Fecha de Firma</h2>
          <div class="grid sm:grid-cols-3 gap-3">
            <input id="DIA" class="input" placeholder="DIA" />
            <input id="MES" class="input" placeholder="MES" />
            <input id="ANO" class="input" placeholder="AÑO" />
          </div>
        </div>

        <!-- 4) Firmante -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">4) Firmante</h2>
          <div class="grid sm:grid-cols-2 gap-3">
            <input id="RL" class="input" placeholder="RL" />
            <input id="CARGO_FIRM" class="input" placeholder="CARGO (Firmante)" />
          </div>
        </div>

        <!-- 5) Servicios Suplementarios -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">5) Servicios Suplementarios</h2>
          <div class="grid sm:grid-cols-3 gap-3">
            <input id="CANTIDAD" class="input" placeholder="CANTIDAD" inputmode="numeric" />
            <input id="SUB_TOTAL" class="input" placeholder="S/ 0.00" inputmode="decimal" />
            <input id="NOMB_PROMOCION" class="input" placeholder="NOMB_PROMOCION" />
          </div>
          <div class="mt-3 grid sm:grid-cols-2 gap-3">
            <input id="DIREC_INST" class="input" placeholder="DIREC_INST (Dirección de instalación)" />
            <input id="CONT_TOTAL" class="input" placeholder="S/ 0.00 (TOTAL opcional)" inputmode="decimal" />
          </div>
        </div>

        <!-- 6) Tarifas y Servicios -->
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-xl font-semibold mb-3">6) Tarifas y Servicios</h2>
          <div class="grid sm:grid-cols-2 gap-3 mb-3">
            <select id="planSelect" class="input">
              <option value="">— Selecciona un plan —</option>
            </select>
            <input id="TARIF_MENS" class="input" placeholder="S/ 0.00" />
          </div>
          <div class="grid sm:grid-cols-3 gap-3">
            <input id="NOM_PLAN" class="input" placeholder="NOM_PLAN" />
            <input id="MIN_GAR" class="input" placeholder="MIN_GAR (%)" />
            <input id="VEL_MAX_BAJ" class="input" placeholder="VEL_MAX_BAJ (Mbps)" inputmode="numeric" />
            <input id="VEL_MIN_BAJ" class="input" placeholder="VEL_MIN_BAJ (Mbps)" inputmode="numeric" />
            <input id="VEL_MAX_SUB" class="input" placeholder="VEL_MAX_SUB (Mbps)" inputmode="numeric" />
            <input id="VEL_MIN_SUB" class="input" placeholder="VEL_MIN_SUB (Mbps)" inputmode="numeric" />
          </div>
          <div class="grid sm:grid-cols-2 gap-3 mt-3">
            <input id="PLAZO_INST" class="input" placeholder="PLAZO_INST (días hábiles)" inputmode="numeric" />
            <select id="PLAZO_CONT" class="input">
              <option value="">— Selecciona plazo (meses) —</option>
              <option value="12">12</option>
              <option value="24">24</option>
              <option value="36">36</option>
            </select>
          </div>
          <div class="mt-4 flex gap-3">
            <button id="btnAuto" class="btn">Autocompletar por plan</button>
            <button id="btnClearPlan" class="btn alt">Limpiar plan</button>
          </div>
        </div>
      </div>

      <!-- Sidebar: UN SOLO BOTÓN -->
      <aside class="space-y-6">
        <div class="bg-slate-900/60 rounded-2xl p-5 shadow">
          <h2 class="text-lg font-semibold mb-3">Exportar PDFs</h2>
          <div class="flex flex-col gap-3">
            <button id="btnExportAll" class="btn w-full">Exportar PDFs</button>
            <a id="downloadLink" class="hidden btn" download>Descargar</a>
            <p id="status" class="text-sm opacity-80"></p>
          </div>
        </div>
      </aside>
    </section>
  </main>

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    /* =============== USUARIOS Y ROLES =============== */
    const USERS_KEY='contratos_users';
    const LOG_KEY='contratos_login_ok';
    const USER_KEY='contratos_login_user';
    const DEFAULT_ADMIN={u:'mob_hmedinab',p:'adminMobilenet2025',role:'admin'};
    const DEFAULT_USER={u:'usuario',p:'usuario123',role:'standard'};

    function loadUsers(){try{return JSON.parse(localStorage.getItem(USERS_KEY))||[]}catch{return []}}
    function saveUsers(a){localStorage.setItem(USERS_KEY,JSON.stringify(a))}
    function ensureDefaults(){
      let arr=loadUsers(); let changed=false;
      if(!arr.some(x=>x&&x.u===DEFAULT_ADMIN.u)){arr.push(DEFAULT_ADMIN);changed=true;}
      if(!arr.some(x=>x&&x.u===DEFAULT_USER.u)){arr.push(DEFAULT_USER);changed=true;}
      if(changed) saveUsers(arr);
    }
    function getLogged(){try{return JSON.parse(localStorage.getItem(USER_KEY))}catch{return null}}
    function setLogged(o){localStorage.setItem(LOG_KEY,'1');localStorage.setItem(USER_KEY,JSON.stringify(o))}
    function clearLogged(){localStorage.removeItem(LOG_KEY);localStorage.removeItem(USER_KEY)}
    function authUser(u,p){
      let arr; try{
        const raw=localStorage.getItem(USERS_KEY);
        arr = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : [];
      }catch{arr=[]}
      if(!arr.length){ensureDefaults();arr=loadUsers();}
      const user=arr.find(x=>x&&x.u===u);
      return (user && String(user.p)===String(p)) ? {u:user.u,role:user.role} : null;
    }

    /* =============== LOGIN =============== */
    function showApp(){document.getElementById('loginOverlay').style.display='none';applyRoleUI();populatePlansSafe();}
    function requireLogin(){
      ensureDefaults();
      const userEl=document.getElementById('loginUser');
      const passEl=document.getElementById('loginPass');
      [userEl,passEl].forEach(el=>el.addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginBtn').click();}));
      const stored=getLogged();
      if(localStorage.getItem(LOG_KEY)==='1' && stored){showApp();return;}
      const btn=document.getElementById('loginBtn');
      const msg=document.getElementById('loginMsg');
      btn.addEventListener('click',()=>{
        const u=userEl.value.trim();
        const p=passEl.value.trim();
        const auth=authUser(u,p);
        if(auth){setLogged(auth);showApp();}
        else{msg.textContent='Usuario o contraseña incorrectos.';setTimeout(()=>msg.textContent='',2500);}
      });
      document.getElementById('resetLogin').addEventListener('click',()=>{
        localStorage.removeItem(USERS_KEY);
        localStorage.removeItem(LOG_KEY);
        localStorage.removeItem(USER_KEY);
        ensureDefaults();
        userEl.value='usuario'; passEl.value='usuario123';
        msg.textContent='Acceso restablecido. Usa usuario/usuario123 o el admin.'; setTimeout(()=>msg.textContent='',3000);
      });
    }
    requireLogin();
    document.getElementById('logoutBtn').addEventListener('click',()=>{clearLogged();location.reload();});

    /* =============== CONFIG (ADMIN) =============== */
    const btnConfig=document.getElementById('btnConfig');
    const modal=document.getElementById('configModal');
    const closeCfg=document.getElementById('closeConfig');
    const usersList=document.getElementById('usersList');
    const whoami=document.getElementById('whoami');

    function applyRoleUI(){
      const me=getLogged(); if(!me) return;
      whoami.textContent=`Sesión: ${me.u} `;
      const r=document.createElement('span'); r.className='badge ml-2'; r.textContent=me.role; whoami.appendChild(r);
      if(me.role==='admin') btnConfig.classList.remove('hidden'); else btnConfig.classList.add('hidden');
    }
    function renderUsers(){
      const arr=loadUsers(); usersList.innerHTML='';
      arr.forEach(u=>{
        const row=document.createElement('div');
        row.className='flex items-center justify-between bg-slate-800/50 px-3 py-2 rounded';
        row.innerHTML=`<div><span class="font-semibold">${u.u}</span><span class="badge ml-2">${u.role}</span></div><span class="text-xs opacity-60">local</span>`;
        usersList.appendChild(row);
      });
    }
    btnConfig.addEventListener('click',()=>{const me=getLogged(); if(!me||me.role!=='admin')return; renderUsers(); modal.style.display='flex';});
    closeCfg.addEventListener('click',()=> modal.style.display='none');
    modal.addEventListener('click',e=>{ if(e.target===modal) modal.style.display='none'; });
    document.getElementById('btnCreateUser').addEventListener('click',()=>{
      const me=getLogged(); if(!me||me.role!=='admin') return;
      const msg=document.getElementById('userMsg');
      const u=document.getElementById('newUser').value.trim();
      const p=document.getElementById('newPass').value.trim();
      let role=document.getElementById('newRole').value;
      if(role!=='standard') role='standard'; // forzar standard
      if(!u||!p){ msg.textContent='Completa usuario y contraseña.'; return; }
      const arr=loadUsers();
      if(arr.some(x=>x.u===u)){ msg.textContent='Ese usuario ya existe.'; return; }
      arr.push({u,p,role}); saveUsers(arr);
      renderUsers(); msg.textContent='Usuario creado.'; setTimeout(()=>msg.textContent='',1500);
      document.getElementById('newUser').value=''; document.getElementById('newPass').value='';
    });

    /* =============== UTIL DINERO =============== */
    const solesFmt=new Intl.NumberFormat('es-PE',{style:'currency',currency:'PEN',minimumFractionDigits:2});
    function normalizeMoneyInput(v){
      if(!v) return '';
      v=String(v).replace(/[^0-9,\.]/g,'').replace(',', '.');
      const n=parseFloat(v); if(isNaN(n)) return '';
      let f=solesFmt.format(n); f=f.replace('PEN','').trim().replace(/^S\$/,'S/').replace('S/.','S/');
      if(!f.startsWith('S/')) f='S/ '+f; return f;
    }
    function attachMoneyFormatter(id){ const el=document.getElementById(id); el.addEventListener('blur',()=>{ el.value=normalizeMoneyInput(el.value); }); }
    ['SUB_TOTAL','CONT_TOTAL','TARIF_MENS'].forEach(attachMoneyFormatter);

    function byId(id){return document.getElementById(id)}
    function setVal(id,val){const el=byId(id); if(el) el.value=val??""}

    /* =============== PLANES =============== */
    const PLANS=[
      {name:"Internet Fibra Plus 100 Mbps - 36M",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 270.00"},
      {name:"Internet Fibra Plus 200 Mbps - 36M",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 360.00"},
      {name:"Internet Fibra Plus 100 Mbps - 24M",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 370.00"},
      {name:"Internet Fibra Plus 200 Mbps - 24M",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 490.00"},
      {name:"Pack Fibra Plus 100 Mbps - 36M",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 279.90"},
      {name:"Pack Fibra Plus 200 Mbps - 36M",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 369.90"},
      {name:"Pack Fibra Plus 100 Mbps - 24M",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 379.90"},
      {name:"Pack Fibra Plus 200 Mbps - 24M",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 499.90"},
      {name:"Internet Dedicado 10 Mbps",minGar:"100%",vmb:10,vminb:10,vms:10,vmins:10,tarif:"S/ 500.00"},
      {name:"Internet Dedicado 20 Mbps",minGar:"100%",vmb:20,vminb:20,vms:20,vmins:20,tarif:"S/ 550.00"},
      {name:"Internet Dedicado 50 Mbps",minGar:"100%",vmb:50,vminb:50,vms:50,vmins:50,tarif:"S/ 590.00"},
      {name:"Internet Dedicado 100 Mbps",minGar:"100%",vmb:100,vminb:100,vms:100,vmins:100,tarif:"S/ 690.00"},
      {name:"Internet Dedicado 200 Mbps",minGar:"100%",vmb:200,vminb:200,vms:200,vmins:200,tarif:"S/ 1,100.00"},
      {name:"Internet Dedicado 250 Mbps",minGar:"100%",vmb:250,vminb:250,vms:250,vmins:250,tarif:"S/ 1,400.00"}
    ];

    function populatePlansSafe(){
      try{
        const planSelect=document.getElementById('planSelect');
        if(!planSelect) return;
        // Limpia por si renderizaste de nuevo
        planSelect.innerHTML = '<option value="">— Selecciona un plan —</option>';
        PLANS.forEach(p=>{
          const o=document.createElement('option');
          o.value=p.name; o.textContent=p.name; planSelect.appendChild(o);
        });
        // Listeners
        function fillPlanFromSelection(){
          const sel=planSelect.value; const p=PLANS.find(x=>x.name===sel); if(!p) return;
          setVal('NOM_PLAN',p.name); setVal('MIN_GAR',p.minGar);
          setVal('VEL_MAX_BAJ',String(p.vmb)); setVal('VEL_MIN_BAJ',String(p.vminb));
          setVal('VEL_MAX_SUB',String(p.vms)); setVal('VEL_MIN_SUB',String(p.vmins));
          setVal('TARIF_MENS',p.tarif);
          const m=p.name.match(/(\d{2})M/); const plazo=m?m[1]:'';
          const plazoSel=document.getElementById('PLAZO_CONT'); if(plazo && ['12','24','36'].includes(plazo)) plazoSel.value=plazo;
        }
        document.getElementById('btnAuto').onclick = fillPlanFromSelection;
        planSelect.onchange = fillPlanFromSelection;
        document.getElementById('btnClearPlan').onclick = ()=>{
          ['NOM_PLAN','MIN_GAR','VEL_MAX_BAJ','VEL_MIN_BAJ','VEL_MAX_SUB','VEL_MIN_SUB','TARIF_MENS'].forEach(id=>setVal(id,''));
          document.getElementById('PLAZO_CONT').value=''; planSelect.value='';
        };
      }catch(e){
        console.error('Error cargando planes', e);
        const st = document.getElementById('status');
        if(st) st.textContent = 'Error cargando planes. Recarga la página.';
      }
    }

    /* =============== RECOLECCIÓN =============== */
    function gatherData(){
      const ids=[
        'RAZON_SOCIAL','RUC','DIRECCION','NUMERO_DE_CALLE','DPTO_INT','URB','DISTRITO','CIUDAD',
        'APELLIDO_PATERNO','APELLIDO_MATERNO','NOMBRES','CARGO','DNI','TELEFONO','CORREO',
        'CONT_NOMB','CONT_CARGO','CONT_DNI','CONT_TELEF','CONT_CORREO',
        'DIA','MES','ANO','RL','CARGO_FIRM',
        'CANTIDAD','SUB_TOTAL','NOMB_PROMOCION','DIREC_INST','CONT_TOTAL',
        'NOM_PLAN','MIN_GAR','VEL_MAX_BAJ','VEL_MIN_BAJ','VEL_MAX_SUB','VEL_MIN_SUB','TARIF_MENS','PLAZO_INST','PLAZO_CONT'
      ];
      const data={};
      ids.forEach(id=>{
        let v=document.getElementById(id)?.value ?? '';
        if(id==='SUB_TOTAL'||id==='CONT_TOTAL'||id==='TARIF_MENS') v=normalizeMoneyInput(v);
        if(id==='PLAZO_CONT') v=String(v).trim();
        data[id]=v;
      });
      return data;
    }

    /* =============== MAPEOS PDF =============== */
    const MAP_ARR={
      'RUC':'RUC','RAZON SOCIAL':'RAZON_SOCIAL','DIRECCION':'DIRECCION','NUMERO DE CALLE':'NUMERO_DE_CALLE',
      'DPTO_INT':'DPTO_INT','URB':'URB','DISTRITO':'DISTRITO','CIUDAD':'CIUDAD',
      'APELLIDO PATERNO':'APELLIDO_PATERNO','APELLIDO MATERNO':'APELLIDO_MATERNO','NOMBRES':'NOMBRES',
      'DNI':'DNI','TELEFONO':'TELEFONO','CORREO':'CORREO',
      'CONT_NOMB':'CONT_NOMB','CONT_CARGO':'CONT_CARGO','CONT_DNI':'CONT_DNI','CONT_TELEF':'CONT_TELEF','CONT_CORREO':'CONT_CORREO',
      'DIA':'DIA','MES':'MES','AÑO':'ANO','RL':'RL','CARGO':'CARGO_FIRM'
    };
    const MAP_SUP={
      'RUC':'RUC','RAZON SOCIAL':'RAZON_SOCIAL','DIRECCION':'DIRECCION','NUMERO DE CALLE':'NUMERO_DE_CALLE','DPTO_INT':'DPTO_INT','URB':'URB','DISTRITO':'DISTRITO','CIUDAD':'CIUDAD',
      'APELLIDO PATERNO':'APELLIDO_PATERNO','APELLIDO MATERNO':'APELLIDO_MATERNO','NOMBRES':'NOMBRES','DNI':'DNI','TELEFONO':'TELEFONO','CORREO':'CORREO',
      'CONT_NOMB':'CONT_NOMB','CONT_CARGO':'CONT_CARGO','CONT_DNI':'CONT_DNI','CONT_TELEF':'CONT_TELEF','CONT_CORREO':'CONT_CORREO',
      'CANTIDAD':'CANTIDAD','SUB_TOTAL':'SUB_TOTAL','TOTAL':'CONT_TOTAL','NOMB_PROMOCION':'NOMB_PROMOCION','DIREC_INST':'DIREC_INST',
      'DIA':'DIA','MES':'MES','AÑO':'ANO','RL':'RL','CARGO':'CARGO_FIRM'
    };
    const MAP_TAR={
      'CARGO FIJO':'TARIF_MENS','CARGO':'CARGO_FIRM','CORREO':'CORREO',
      'DIA':'DIA','MES':'MES','AÑO':'ANO','RL':'RL',
      'NOM_PLAN':'NOM_PLAN','MIN_GAR':'MIN_GAR','VEL_MAX_BAJ':'VEL_MAX_BAJ','VEL_MIN_BAJ':'VEL_MIN_BAJ','VEL_MAX_SUB':'VEL_MAX_SUB','VEL_MIN_SUB':'VEL_MIN_SUB',
      'TARIF_MENS':'TARIF_MENS','DIREC_INST':'DIREC_INST','PLAZO_INST':'PLAZO_INST','PLAZO_CONT':'PLAZO_CONT'
    };

    async function fillOne(pdfFileName,map){
      const status=document.getElementById('status');
      try{
        status.textContent='Cargando '+pdfFileName+'...';
        const resp=await fetch(pdfFileName);
        if(!resp.ok) throw new Error('No se pudo cargar (¿está en la misma carpeta?)');
        const arr=await resp.arrayBuffer();
        const pdfDoc=await PDFLib.PDFDocument.load(arr);
        const form=pdfDoc.getForm();
        const data=gatherData();
        let filled=0;
        for(const [pdfField,htmlId] of Object.entries(map)){
          try{const tf=form.getTextField(pdfField); tf.setText(data[htmlId]??''); filled++; }
          catch(e){ console.warn('Campo faltante en', pdfFileName, ':', pdfField); }
        }
        form.flatten();
        const bytes=await pdfDoc.save();
        const blob=new Blob([bytes],{type:'application/pdf'});
        const url=URL.createObjectURL(blob);
        const a=document.getElementById('downloadLink');
        a.href=url; a.download=pdfFileName; a.classList.remove('hidden'); a.click();
        status.textContent='Generado '+pdfFileName+' ('+filled+' campos).';
      }catch(err){
        console.error(err);
        status.textContent='Error con '+pdfFileName+': '+err.message;
      }
    }

    async function exportAll(){
      await fillOne('Arrendamiento.pdf',MAP_ARR);
      await fillOne('Servicios Suplementarios.pdf',MAP_SUP);
      await fillOne('Tarifas y Servicios.pdf',MAP_TAR);
    }
    document.getElementById('btnExportAll').addEventListener('click',exportAll);
  </script>
</body>
</html>
